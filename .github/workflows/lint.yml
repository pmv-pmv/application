name: Lint and Format Check
on:
  pull_request:
  push:

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run markdownlint
        id: markdownlint
        uses: nosborn/github-action-markdown-cli@v3.5.0
        continue-on-error: true
        with:
          files: .
          dot: true

      - name: Run Prettier
        id: prettier
        uses: creyD/prettier_action@v4.6
        continue-on-error: true
        with:
          dry: true
          prettier_options: --check .

      - name: Run CSpell
        id: cspell
        uses: streetsidesoftware/cspell-action@v8.2.0
        continue-on-error: true
        with:
          strict: false

      - name: Setup Node for HTML ESLint and Run HTML ESLint
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Install HTML ESLint
        run: npm install --save-dev eslint @html-eslint/parser @html-eslint/eslint-plugin

      - name: Run HTML ESLint
        id: htmllint
        uses: sibiraj-s/action-eslint@v4
        continue-on-error: true
        with:
          extensions: "html"
          annotations: true
          all-files: true

      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Run Black
        id: black
        uses: psf/black@stable
        continue-on-error: true
        with:
          options: "--check --verbose --extend-exclude='node_modules/'"

      - name: Run isort
        id: isort
        continue-on-error: true
        run: |
          pip install isort
          isort --check-only --diff --skip node_modules .

      - name: Run Pylint
        id: pylint
        continue-on-error: true
        run: |
          pip install pylint
          files=$(find . -name "*.py" -not -path "*/venv/*" -not -path "*/.venv/*")
          if [ -n "$files" ]; then
            pylint --fail-under=7.5 --disable=import-error $files
          else
            echo "No Python files found."
          fi
      - name: Check Linting Results
        if: always()
        run: |
          echo "## Linting Results Summary " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          failed=0
          passed=0

          if [ "${{ steps.markdownlint.outcome }}" != "success" ]; then
            echo "Markdownlint: FAILED. Please check its warnings!" >> $GITHUB_STEP_SUMMARY
            # failed=$((failed + 1))
          else
            echo "Markdownlint: PASSED" >> $GITHUB_STEP_SUMMARY
            passed=$((passed + 1))
          fi

          if [ "${{ steps.prettier.outcome }}" != "success" ]; then
            echo "Prettier: FAILED. Please check its warnings!" >> $GITHUB_STEP_SUMMARY
            # failed=$((failed + 1))
          else
            echo "Prettier: PASSED" >> $GITHUB_STEP_SUMMARY
            passed=$((passed + 1))
          fi

          if [ "${{ steps.cspell.outcome }}" != "success" ]; then
            echo "CSpell: FAILED. Please check its warnings!" >> $GITHUB_STEP_SUMMARY
            # failed=$((failed + 1))
          else
            echo "CSpell: PASSED" >> $GITHUB_STEP_SUMMARY
            passed=$((passed + 1))
          fi

          if [ "${{ steps.htmllint.outcome }}" != "success" ]; then
            echo "HTML ESLint: FAILED !!!" >> $GITHUB_STEP_SUMMARY
            failed=$((failed + 1))
          else
            echo "HTML ESLint: PASSED" >> $GITHUB_STEP_SUMMARY
            passed=$((passed + 1))
          fi

          if [ "${{ steps.gitleaks.outcome }}" != "success" ]; then
            echo "Gitleaks: FAILED !!!" >> $GITHUB_STEP_SUMMARY
            failed=$((failed + 1))
          else
            echo "Gitleaks: PASSED" >> $GITHUB_STEP_SUMMARY
            passed=$((passed + 1))
          fi

          if [ "${{ steps.black.outcome }}" != "success" ]; then
            echo "Black: FAILED. Please check its warnings!" >> $GITHUB_STEP_SUMMARY
            # failed=$((failed + 1))
          else
            echo "Black: PASSED" >> $GITHUB_STEP_SUMMARY
            passed=$((passed + 1))
          fi

          if [ "${{ steps.isort.outcome }}" != "success" ]; then
            echo "isort: FAILED. Please check its warnings!" >> $GITHUB_STEP_SUMMARY
            # failed=$((failed + 1))
          else
            echo "isort: PASSED" >> $GITHUB_STEP_SUMMARY
            passed=$((passed + 1))
          fi

          if [ "${{ steps.pylint.outcome }}" != "success" ]; then
            echo "Pylint: FAILED !!!" >> $GITHUB_STEP_SUMMARY
            failed=$((failed + 1))
          else
            echo "Pylint: PASSED" >> $GITHUB_STEP_SUMMARY
            passed=$((passed + 1))
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total: $passed passed, $failed failed**" >> $GITHUB_STEP_SUMMARY

          if [ $failed -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**If you see any **Failed** results, please fix the linting and formatting issues above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
